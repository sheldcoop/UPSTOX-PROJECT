#!/usr/bin/env python3
"""
NiceGUI Trading Dashboard v2.5
Refactored for Performance, Concurrency, and Component Reusability.
Includes optimized sidebars and enhanced styling.
"""

from nicegui import ui, run
import requests
from datetime import datetime, timedelta
from typing import Dict, Any, List, Optional, Callable
import asyncio

# Configuration
API_BASE = "http://localhost:9000"
REFRESH_INTERVAL = 30000  # 30 seconds

# ============================================================================
# üé® Theme & Appearance
# ============================================================================

class Theme:
    """Centralized Theme Configuration"""
    PRIMARY = '#6366f1'  # Indigo-500
    SECONDARY = '#ec4899' # Pink-500
    ACCENT = '#3b82f6'    # Blue-500
    DARK_BG = '#0b1220'   # Slate-950 equivalent
    CARD_BG = '#0f172a'   # Slate-900
    SUCCESS = '#10b981'   # Emerald-500
    DANGER = '#ef4444'    # Red-500
    WARNING = '#f59e0b'
    
    @staticmethod
    def apply():
        ui.colors(
            primary=Theme.PRIMARY,
            secondary=Theme.SECONDARY,
            accent=Theme.ACCENT,
            dark=Theme.DARK_BG,
            positive=Theme.SUCCESS,
            negative=Theme.DANGER
        )
        ui.add_css(f'''
            body {{ background-color: {Theme.DARK_BG}; }}
            .glass {{ background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(10px); }}
            ::-webkit-scrollbar {{ width: 8px; height: 8px; }}
            ::-webkit-scrollbar-thumb {{ background: #1f2937; border-radius: 8px; }}
            ::-webkit-scrollbar-track {{ background: {Theme.DARK_BG}; }}
        ''')

# ============================================================================
# üß© Reusable Components
# ============================================================================

class Components:
    """Library of reusable UI components for consistency"""
    
    @staticmethod
    def section_header(title: str, subtitle: str = None, icon: str = None):
        """Standardized page header with gradient text"""
        with ui.row().classes('items-center gap-3 mb-6 animate-fade-in'):
            if icon:
                ui.label(icon).classes('text-3xl text-indigo-400')
            with ui.column().classes('gap-0'):
                ui.label(title).classes('text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-pink-400')
                if subtitle:
                    ui.label(subtitle).classes('text-sm text-slate-400 font-medium')

    @staticmethod
    def card(classes: str = '') -> ui.card:
        """Standardized card with consistent styling"""
        return ui.card().classes(f'w-full bg-slate-900/50 border border-slate-800 p-6 rounded-xl shadow-lg backdrop-blur-sm {classes}')

    @staticmethod
    def kpi_card(title: str, value: Any, delta: float = 0, prefix: str = '', suffix: str = '', subtext: str = ''):
        """Metric card with trend indicator"""
        with Components.card().classes('flex-1 min-w-[240px] hover:border-indigo-500/50 transition-colors duration-300'):
            with ui.row().classes('w-full justify-between items-start'):
                ui.label(title).classes('text-xs font-bold text-slate-400 uppercase tracking-wider')
                if delta != 0:
                    color = 'text-green-400' if delta > 0 else 'text-red-400'
                    icon = 'trending_up' if delta > 0 else 'trending_down'
                    with ui.row().classes(f'items-center gap-1 {color} bg-slate-800/50 px-2 py-0.5 rounded-full text-xs'):
                        ui.icon(icon, size='xs')
                        ui.label(f'{abs(delta):.2f}%')

            # Value Rendering
            val_display = f"{prefix}{value:,.2f}{suffix}" if isinstance(value, (int, float)) else str(value)
            ui.label(val_display).classes('text-2xl font-bold text-white mt-2')
            
            if subtext:
                ui.label(subtext).classes('text-xs text-slate-500 mt-1')

    @staticmethod
    def date_input(label: str, value: str = None) -> ui.input:
        """Input field with popup calendar"""
        with ui.input(label=label, value=value).props('outlined dense dark readonly').classes('flex-1') as input_field:
            with ui.menu().props('no-parent-event') as menu:
                with ui.date().bind_value(input_field).props('dark square'):
                    with ui.row().classes('justify-end p-2'):
                        ui.button('Select', on_click=menu.close).props('flat dense color=primary')
            
            with input_field.add_slot('append'):
                ui.icon('event').on('click', menu.open).classes('cursor-pointer text-slate-400 hover:text-white')
        return input_field

    @staticmethod
    def data_table(columns: List[Dict], rows: List[Dict], title: str = None):
        """Configured AgGrid for data display"""
        if title:
            ui.label(title).classes('text-lg font-bold mb-2 text-slate-300')
        
        return ui.table(
            columns=columns,
            rows=rows,
            pagination={'rowsPerPage': 10}
        ).classes('w-full bg-slate-900 border border-slate-800 shadow-sm rounded-lg')

# ============================================================================
# üì° Async API Wrappers
# ============================================================================

async def async_get(endpoint: str, timeout: int = 5) -> Dict[str, Any]:
    try:
        response = await run.io_bound(requests.get, f"{API_BASE}{endpoint}", timeout=timeout)
        if response.status_code == 200:
            return response.json()
        return {"error": f"Status {response.status_code}"}
    except Exception as e:
        return {"error": str(e)}

async def async_post(endpoint: str, data: Dict, timeout: int = 30) -> Dict[str, Any]:
    try:
        response = await run.io_bound(requests.post, f"{API_BASE}{endpoint}", json=data, timeout=timeout)
        if response.status_code in [200, 201]:
            return response.json()
        return {"error": f"Status {response.status_code}"}
    except Exception as e:
        return {"error": str(e)}

# ============================================================================
# üß† Application State
# ============================================================================

class DashboardState:
    def __init__(self):
        self.current_page: str = 'dashboard'
        self.portfolio: Dict[str, Any] = {}
        self.download_history: Dict[str, Any] = {}
        self.selected_symbols: List[str] = []
        self.is_sidebar_collapsed: bool = False
    
    async def fetch_portfolio(self):
        self.portfolio = await async_get("/api/portfolio")
        return self.portfolio

    async def fetch_download_history(self):
        self.download_history = await async_get("/api/download/history")
        return self.download_history

    def get_instruments_sync(self, category: str) -> List[str]:
        """Fetch instruments based on category (IO bound wrapper)"""
        try:
            import sqlite3
            conn = sqlite3.connect('market_data.db')
            cursor = conn.cursor()
            
            # Categories: 'NSE_EQ', 'BSE_EQ', 'DERIVATIVES', 'DEBT', 'GOLD', 'INDICES_ETF'
            query = ""
            if category == 'NSE_EQ':
                query = "SELECT i.symbol FROM instruments i JOIN instrument_types it ON i.type_code = it.code WHERE i.segment_id='NSE_EQ' AND it.category='Equity' ORDER BY i.symbol ASC"
            elif category == 'BSE_EQ':
                query = "SELECT i.symbol FROM instruments i JOIN instrument_types it ON i.type_code = it.code WHERE i.segment_id='BSE_EQ' AND it.category='Equity' ORDER BY i.symbol ASC"
            elif category == 'DEBT':
                query = "SELECT i.symbol FROM instruments i JOIN instrument_types it ON i.type_code = it.code WHERE it.category = 'Bond' ORDER BY i.symbol ASC"
            elif category == 'GOLD':
                query = "SELECT i.symbol FROM instruments i WHERE i.type_code = 'SG' ORDER BY i.symbol ASC"
            elif category == 'INDICES':
                query = "SELECT i.symbol FROM instruments i JOIN instrument_types it ON i.type_code = it.code WHERE it.category = 'Index' ORDER BY i.symbol ASC"
            elif category == 'ETFs':
                query = "SELECT i.symbol FROM instruments i JOIN instrument_types it ON i.type_code = it.code WHERE it.category = 'ETF' ORDER BY i.symbol ASC"
            elif category == 'SME_EQ':
                # 'SM' = NSE SME, 'M' = BSE SME (Verified from DB)
                query = "SELECT i.symbol FROM instruments i WHERE i.type_code IN ('SM', 'M') ORDER BY i.symbol ASC"
            elif category == 'FNO_UNDERLYING':
                query = "SELECT DISTINCT underlying_symbol FROM derivatives_metadata ORDER BY underlying_symbol ASC"
            
            if query:
                cursor.execute(query)
                stocks = [row[0] for row in cursor.fetchall()]
                conn.close()
                return stocks
            return []
        except Exception as e:
            print(f"Error loading {category}: {e}")
            return []

# ============================================================================
# üñ•Ô∏è Main UI Logic
# ============================================================================

@ui.page('/')
def main_dashboard():
    Theme.apply()
    state = DashboardState()

    # --- Navigation Logic ---
    def navigate_to(page_id: str):
        state.current_page = page_id
        content_area.refresh()
        if ui.context.client.layout.width < 1024: 
             drawer.hide()

    def toggle_sidebar():
        state.is_sidebar_collapsed = not state.is_sidebar_collapsed
        if state.is_sidebar_collapsed:
            drawer.props(add='mini') # Use native mini mode
        else:
            drawer.props(remove='mini') 
        # No need to refresh sidebar_content manually if using mini mode props correctly, 
        # but since we have custom logic for labels, we keep it.
        sidebar_content.refresh()

    # --- Header ---
    with ui.header().classes('glass border-b border-slate-800 px-4 py-3 h-16'):
        with ui.row().classes('w-full items-center justify-between'):
            with ui.row().classes('items-center gap-4'):
                # Mobile Toggle
                ui.button(icon='menu', on_click=lambda: drawer.toggle()).props('flat dense rounded').classes('text-slate-300 lg:hidden')
                # Desktop Collapse/Expand
                ui.button(icon='menu_open', on_click=toggle_sidebar).props('flat dense rounded').classes('text-slate-300 hidden lg:block rotate-180')
                
                with ui.row().classes('items-center gap-2'):
                    ui.icon('rocket_launch', size='md').classes('text-indigo-500')
                    ui.label('UPSTOX').classes('text-xl font-bold tracking-tight text-white/90')
                    ui.label('ALGO v2').classes('text-xs font-mono bg-blue-900/30 text-blue-400 px-2 py-0.5 rounded border border-blue-800')

            with ui.row().classes('items-center gap-4 ml-auto'):
                ui.button('REFRESH', icon='refresh', on_click=lambda: refresh_all_data()).props('flat dense').classes('text-slate-400 hover:text-white')
                
                # Auth Controls (Refreshable)
                @ui.refreshable
                def auth_controls():
                    is_auth = state.portfolio.get('authenticated', False)
                    mode = state.portfolio.get('mode', 'unknown')
                    
                    if is_auth:
                        ui.chip('LIVE', icon='check_circle', color='green').props('dense square outline')
                    elif mode == 'paper':
                        ui.chip('PAPER TRADING', icon='science', color='orange').props('dense square outline').tooltip('You are viewing simulated data. Login to trade live.')
                        
                    if not is_auth:
                        def open_login():
                            import webbrowser
                            # Use a new browser tab/window for the external Upstox login
                            # Port 5050 to avoid MacOS AirPlay conflict on port 5000
                            webbrowser.open('http://127.0.0.1:5050/auth/start')

                        ui.button('Login', icon='login', on_click=open_login).classes('bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold ml-4')
                
                auth_controls()

                ui.avatar('img:https://cdn.quasar.dev/img/boy-avatar.png', size='md').classes('border border-slate-600')

    # --- Sidebar ---
    # Using 'mini-to-overlay' might be good for mobile, but 'desktop' behavior is standard. 
    # Removed specific width prop to let mini mode handle it, or set default width.
    drawer = ui.left_drawer(value=True).props('show-if-above bordered :width="260" :mini-width="80" behavior=desktop').classes('bg-slate-950 border-r border-slate-800 transition-all duration-300')
    
    with drawer:
        @ui.refreshable
        def sidebar_content():
            is_mini = state.is_sidebar_collapsed
            
            with ui.column().classes('w-full h-full justify-between py-4'):
                # Navigation Items
                with ui.column().classes('w-full gap-1'):
                    
                    def menu_item(label, page, icon_name):
                        is_active = state.current_page == page
                        bg_class = 'bg-indigo-600/10 text-indigo-400 border-r-2 border-indigo-500' if is_active else 'text-slate-400 hover:text-slate-200 hover:bg-slate-800/50'
                        
                        tooltip = label if is_mini else None
                        
                        # Fix: Use row instead of button for better control in mini mode
                        with ui.element('div').classes(f'w-full cursor-pointer {bg_class} relative group') as container:
                             container.on('click', lambda p=page: navigate_to(p))
                             
                             # Layout: Icon + Label
                             with ui.row().classes(f'w-full items-center py-3 px-4 {"justify-center" if is_mini else "justify-start gap-4"}'):
                                 ui.icon(icon_name).classes('text-2xl transition-transform group-hover:scale-110')
                                 if not is_mini:
                                     ui.label(label).classes('text-sm font-medium whitespace-nowrap overflow-hidden animate-fade-in')
                        
                        if tooltip:
                            ui.tooltip(tooltip).props('anchor="center right" self="center left" :offset="[10, 10]"').classes('bg-slate-900 border border-slate-700 text-xs')

                    def menu_group(title):
                        if not is_mini:
                            ui.label(title).classes('text-[10px] font-bold text-slate-600 uppercase px-4 mt-4 mb-2 tracking-wider')
                        else:
                            ui.separator().classes('my-2 border-slate-800 w-1/2 mx-auto')

                    # Render Menu
                    menu_group('Core')
                    menu_item('Dashboard', 'dashboard', 'dashboard')
                    menu_item('Data Downloads', 'downloads', 'cloud_download')
                    
                    menu_group('Trading')
                    menu_item('Positions', 'positions', 'pie_chart')
                    menu_item('Orders', 'orders', 'list_alt')
                    menu_item('Options & Futures', 'fno_analysis', 'timeline')
                    
                    menu_group('Tools')
                    menu_item('Backtest', 'backtest', 'science')
                    menu_item('Market Guide', 'market_guide', 'library_books')
                    menu_item('Configurations', 'settings', 'settings')

                # Sidebar Footer
                if not is_mini:
                    with ui.column().classes('px-4 pb-2 opacity-50'):
                        ui.label('System Online').classes('text-xs text-green-500 font-mono')
                        ui.linear_progress(value=1.0, color='green', show_value=False).classes('h-1 rounded')

        sidebar_content()

    # --- Content ---
    @ui.refreshable
    def content_area():
        # Pages wrap content in a consistent padding container
        with ui.column().classes('w-full h-full max-w-7xl mx-auto animate-fade-in'):
            if state.current_page == 'dashboard':
                render_dashboard_page()
            elif state.current_page == 'downloads':
                render_downloads_page()
            elif state.current_page == 'positions':
                render_positions_page()
            elif state.current_page == 'fno_analysis':
                render_fno_page()
            elif state.current_page == 'market_guide':
                render_market_guide_page()
            else:
                render_wip_page(state.current_page)

    # --- Page Definitions ---

    def render_fno_page():
        Components.section_header('F&O Analysis', 'Derivatives Data & Option Chain', 'timeline')
        
        with ui.row().classes('w-full gap-6 items-start'):
            # Selection Panel
            with ui.column().classes('w-1/4 gap-4'):
                with Components.card():
                    ui.label('Select Underlying').classes('text-lg font-bold mb-4')
                    
                    # Fetch Unique Underlyings (approx 207)
                    underlyings = state.get_instruments_sync('FNO_UNDERLYING')
                    
                    # Store selected underlying in local closure or state
                    selected_script = ui.select(
                        options=underlyings, 
                        label='Script', 
                        with_input=True
                    ).props('outlined dense dark use-input behavior="menu"').classes('w-full')
                    
                    ui.label('Contracts').classes('text-sm font-bold text-slate-400 mt-4')
                    contract_list = ui.column().classes('w-full gap-1 max-h-[400px] overflow-y-auto')
                    
                    def load_contracts(e):
                        script = e.value
                        if not script: return
                        
                        # For now, we simulate fetching contracts or just show a message
                        # In a real impl, we'd query derivatives_metadata for this underlying
                        contract_list.clear()
                        with contract_list:
                            ui.label(f'Loading contracts for {script}...').classes('text-xs animate-pulse')
                            
                            # Simple DB Query to get counts
                            try:
                                import sqlite3
                                conn = sqlite3.connect('market_data.db')
                                c = conn.cursor()
                                c.execute("""
                                    SELECT option_type, COUNT(*), MIN(expiry_date) 
                                    FROM derivatives_metadata 
                                    WHERE underlying_symbol = ? 
                                    GROUP BY option_type
                                """, (script,))
                                stats = c.fetchall()
                                conn.close()
                                
                                for type_, count, next_exp in stats:
                                    with ui.row().classes('w-full justify-between bg-slate-800 p-2 rounded'):
                                        ui.label(f"Option {type_}" if type_ in ['CE', 'PE'] else "Futures").classes('text-sm font-bold')
                                        ui.label(f"{count} contracts").classes('text-xs text-slate-400')
                            except:
                                ui.label('Error loading data').classes('text-red-400')

                    selected_script.on('update:model-value', load_contracts)

            # Main Content Area (Option Chain Placeholder)
            with ui.column().classes('w-3/4'):
                with Components.card('h-full min-h-[500px] items-center justify-center'):
                    ui.icon('analytics', size='5xl').classes('text-slate-700 mb-4')
                    ui.label('Select a script to view Chain').classes('text-xl text-slate-500 font-medium')
                    ui.label('Real-time Option Chain & Greeks coming soon').classes('text-sm text-slate-600')
    # --- Page Definitions ---

    def render_dashboard_page():
        Components.section_header('Dashboard', 'Real-time portfolio overview', 'analytics')
        
        # Stats Grid
        stats_widget()
        
        # Split Layout
        with ui.grid(columns=2).classes('w-full gap-6 mt-6'):
            # Market Status Card
            with Components.card():
                ui.label('Market Snapshot').classes('text-lg font-bold text-white mb-4')
                with ui.column().classes('gap-4'):
                    indices = [
                        ('NIFTY 50', '19,425.30', 0.45),
                        ('BANK NIFTY', '43,880.00', -0.12),
                        ('INDIA VIX', '11.45', -2.30)
                    ]
                    for name, val, chg in indices:
                        with ui.row().classes('w-full justify-between items-center border-b border-slate-800 pb-2'):
                            ui.label(name).classes('text-slate-400 text-sm')
                            with ui.row().classes('items-center gap-2'):
                                ui.label(val).classes('font-mono font-bold text-white')
                                color = 'text-green-400' if chg > 0 else 'text-red-400'
                                ui.label(f'{chg}%').classes(f'text-xs {color}')

            # Quick Actions Card
            with Components.card():
                ui.label('Quick Actions').classes('text-lg font-bold text-white mb-4')
                with ui.row().classes('gap-2 flex-wrap'):
                    ui.button('Place Order', icon='add').props('outline color=indigo')
                    ui.button('Square Off All', icon='close').props('outline color=red')
                    ui.button('Option Chain', icon='link').props('outline color=grey')

    @ui.refreshable
    def stats_widget():
        """Refreshes independently for high-frequency updates"""
        pf = state.portfolio
        with ui.row().classes('w-full gap-4 flex-wrap'):
            Components.kpi_card('Total Value', pf.get('total_value', 0), delta=0.5, prefix='‚Çπ')
            Components.kpi_card('Day P&L', pf.get('total_pnl', 0), delta=1.2, prefix='‚Çπ')
            Components.kpi_card('Cash Balance', pf.get('cash', 0), prefix='‚Çπ')
            Components.kpi_card('Active Positions', len(pf.get('positions', [])), suffix=' open')

    def render_downloads_page():
        Components.section_header('Data Center', 'Historical market data downloader', 'cloud_download')
        
        with ui.row().classes('w-full gap-6 items-start'):
            # Left Column: Controls
            with ui.column().classes('flex-[2] gap-6'):
                with Components.card():
                    with ui.row().classes('w-full justify-between items-center mb-4'):
                        ui.label('Instrument Selection').classes('text-lg font-bold')
                        ui.icon('search', size='sm').classes('text-slate-500')
                    
                    # Chip container (Moved to top for visibility)
                    chip_container = ui.row().classes('gap-2 mb-4 min-h-[40px] w-full p-2 bg-slate-950/30 rounded border border-slate-800')
                    
                    def render_chips():
                        chip_container.clear()
                        with chip_container:
                            if not state.selected_symbols:
                                ui.label('No symbols selected').classes('text-xs text-slate-500 italic')
                            for s in state.selected_symbols:
                                ui.chip(s, removable=True, on_remove=lambda sym=s: remove_symbol(sym)) \
                                    .classes('bg-indigo-900/50 border border-indigo-500/30 text-xs')

                    def add_symbol(val):
                        if not val: return
                        val = val.upper().strip()
                        if val and val not in state.selected_symbols:
                            state.selected_symbols.append(val)
                            render_chips()
                            # ui.notify(f'Added {val}', type='positive', position='top')

                    def remove_symbol(sym):
                        if sym in state.selected_symbols:
                            state.selected_symbols.remove(sym)
                            render_chips()
                    
                    # Tabs for Universe Selection
                    with ui.tabs().classes('w-full text-slate-400 border-b border-slate-800') as tabs:
                        t_nse = ui.tab('NSE EQ').classes('text-xs')
                        t_bse = ui.tab('BSE EQ').classes('text-xs')
                        t_sme = ui.tab('SME').classes('text-xs')
                        t_debt = ui.tab('Debt').classes('text-xs')
                        t_gold = ui.tab('Gold').classes('text-xs')
                        t_indices = ui.tab('Indices').classes('text-xs')
                        t_etf = ui.tab('ETFs').classes('text-xs')

                    with ui.tab_panels(tabs, value=t_nse).classes('w-full bg-transparent mt-2'):
                        
                        # Helper for search boxes
                        def instrument_search_box(category, label):
                            options = state.get_instruments_sync(category)
                            # Warning for heavy lists
                            ph = f"Search {len(options)} instruments..." if options else "No instruments found"
                            
                            sel = ui.select(
                                options=options,
                                label=label,
                                with_input=True,
                                new_value_mode='add-unique',
                                clearable=True
                            ).props(f'outlined dense dark use-input hide-selected fill-input input-debounce="0" behavior="menu" placeholder="{ph}"').classes('w-full')
                            
                            sel.on('update:model-value', lambda e: (add_symbol(e.args), sel.set_value(None)))
                            return sel

                        with ui.tab_panel(t_nse).classes('p-0'):
                            instrument_search_box('NSE_EQ', 'Search NSE Stocks')

                        with ui.tab_panel(t_bse).classes('p-0'):
                            instrument_search_box('BSE_EQ', 'Search BSE Stocks')

                        with ui.tab_panel(t_sme).classes('p-0'):
                            instrument_search_box('SME_EQ', 'Search SME Stocks (NSE/BSE)')
                            
                        with ui.tab_panel(t_debt).classes('p-0'):
                            instrument_search_box('DEBT', 'Search Bonds & Fixed Income')
                            
                        with ui.tab_panel(t_gold).classes('p-0'):
                            instrument_search_box('GOLD', 'Search Gold Bonds (SGB)')
                            
                        with ui.tab_panel(t_indices).classes('p-0'):
                            instrument_search_box('INDICES', 'Search Market Indices')
                            
                        with ui.tab_panel(t_etf).classes('p-0'):
                            instrument_search_box('ETFs', 'Search Exchange Traded Funds')

                    render_chips()
                    
                    # Date Selection
                    ui.label('Time Period').classes('text-sm font-bold text-slate-400 mt-4 mb-2')
                    with ui.row().classes('w-full gap-4'):
                        d_from = Components.date_input('Start From', value=(datetime.now() - timedelta(30)).strftime('%Y-%m-%d'))
                        d_to = Components.date_input('End To', value=datetime.now().strftime('%Y-%m-%d'))
                    
                    # Quick Ranges
                    with ui.row().classes('gap-2 mt-2'):
                        def set_range(days: int):
                            d_to.value = datetime.now().strftime('%Y-%m-%d')
                            d_from.value = (datetime.now() - timedelta(days=days)).strftime('%Y-%m-%d')
                        
                        for label, days in [('1W', 7), ('1M', 30), ('3M', 90), ('YTD', (datetime.now() - datetime(datetime.now().year, 1, 1)).days)]:
                            ui.chip(label, on_click=lambda d=days: set_range(d)).props('clickable dense square outline icon=calendar_today').classes('hover:bg-indigo-500 hover:text-white text-xs')

                    # Options
                    ui.label('Output Options').classes('text-sm font-bold text-slate-400 mt-4 mb-2')
                    with ui.column().classes('gap-2'):
                         save_db_switch = ui.switch('Save to Database', value=True).props('color=green dense dark')
                         with ui.row().classes('items-center gap-4'):
                             download_local_switch = ui.switch('Download Local File', value=False).props('color=blue dense dark')
                             file_format = ui.select(['parquet', 'csv'], value='parquet', label='Format').props('dense outlined dark options-dense').classes('w-32').bind_visibility_from(download_local_switch, 'value')

                    status_label = ui.label('').classes('text-sm mt-2')

                    async def run_download():
                        if not state.selected_symbols:
                            ui.notify('Select at least one symbol', type='warning')
                            return
                        
                        if not save_db_switch.value and not download_local_switch.value:
                            ui.notify('Select at least one output option', type='warning')
                            return
                        
                        status_label.text = '‚è≥ Requesting data...'
                        
                        # Determine export format
                        # If download local is True, we MUST ask for a file (parquet or csv)
                        # If download local is False, we can set export_format to None to avoid generating a file, 
                        # UNLESS the user might want to generate it on server but not download it.
                        # Assuming 'Download Local File' means 'Generate and Download'. 
                        fmt = file_format.value if download_local_switch.value else None

                        res = await async_post('/api/download/stocks', {
                            "symbols": state.selected_symbols,
                            "start_date": d_from.value,
                            "end_date": d_to.value,
                            "interval": "1d",
                            "save_db": save_db_switch.value,
                            "export_format": fmt
                        })
                        
                        if 'error' in res:
                            status_label.text = '‚ùå Failed'
                            status_label.classes('text-red-400')
                        else:
                            status_label.text = '‚úÖ Complete'
                            status_label.classes('text-green-400')
                            
                            # Trigger Download if requested
                            if download_local_switch.value and res.get('filepath'):
                                ui.download(res['filepath'])
                                ui.notify('File download started', type='positive')
                                
                            await refresh_dl_list()

                    ui.button('Download Data', icon='download', on_click=run_download).classes('w-full mt-4 bg-indigo-600 hover:bg-indigo-500')

            # Right Column: History
            with ui.column().classes('flex-[3]'):
                with Components.card():
                    ui.label('Recent Files').classes('text-lg font-bold mb-4')
                    history_list = ui.column().classes('w-full gap-2')
                    
                    async def refresh_dl_list():
                        hist = await state.fetch_download_history()
                        history_list.clear()
                        with history_list:
                            if not hist.get('files'):
                                ui.label('No files found').classes('text-slate-500 italic')
                            for f in hist['files'][:8]:
                                with ui.row().classes('w-full justify-between items-center bg-slate-800/30 p-3 rounded hover:bg-slate-800/50 transition'):
                                    with ui.row().classes('gap-3 items-center'):
                                        ui.icon('description', size='sm').classes('text-indigo-400')
                                        ui.label(f['filename']).classes('font-mono text-sm')
                                    ui.label(f"{f['size']/1024:.0f} KB").classes('text-xs text-slate-500')

                    # Init Load
                    ui.timer(0.1, refresh_dl_list, once=True)

    def render_positions_page():
        Components.section_header('Live Positions', 'Manage open trades', 'pie_chart')
        
        pos_data = state.portfolio.get('positions', [])
        
        if not pos_data:
            with Components.card('items-center justify-center py-12'):
                ui.icon('inbox', size='4xl').classes('text-slate-700 mb-4')
                ui.label('No active positions').classes('text-xl text-slate-500')
        else:
            Components.data_table(
                columns=[
                    {'name': 'symbol', 'label': 'Symbol', 'field': 'symbol', 'align': 'left'},
                    {'name': 'qty', 'label': 'Quantity', 'field': 'qty'},
                    {'name': 'ltp', 'label': 'LTP', 'field': 'ltp'},
                    {'name': 'pnl', 'label': 'P&L', 'field': 'pnl', 'format': lambda val: f'‚Çπ{val}'}
                ],
                rows=pos_data
            )

    def render_market_guide_page():
        Components.section_header('Market Guide', 'Instrument Categories & Codes from Documentation', 'library_books')
        
        try:
            with open('MARKET_INSTRUMENTS_GUIDE.md', 'r') as f:
                content = f.read()
            
            with Components.card():
                # render markdown with some custom styling for tables to ensure they look good in dark mode
                ui.markdown(content).classes('prose prose-invert prose-slate max-w-none w-full')
        except Exception as e:
             with Components.card():
                ui.label(f'Error loading documentation: {str(e)}').classes('text-red-400')

    def render_wip_page(name: str):
        Components.section_header(name.replace('_', ' ').title(), 'Under Construction', 'construction')
        with Components.card('border-dashed border-2 border-slate-700 bg-transparent items-center justify-center py-20'):
            ui.spinner('dots', size='lg', color='indigo')
            ui.label('Module Loading...').classes('mt-4 text-slate-500')

    # --- Data Cycle ---
    async def refresh_all_data():
        await asyncio.gather(state.fetch_portfolio())
        auth_controls.refresh() # Update auth badge/button
        if state.current_page == 'dashboard':
            stats_widget.refresh()
        elif state.current_page == 'positions':
            content_area.refresh()
        ui.notify('Data Synced', type='positive', position='bottom-right', timeout=1000)

    # Boot loop
    ui.timer(0.1, refresh_all_data, once=True)
    ui.timer(REFRESH_INTERVAL / 1000.0, refresh_all_data)

    # Layout Mount
    with ui.column().classes('w-full flex-grow overflow-auto p-4 sm:p-6 bg-slate-950'):
        content_area()

ui.run(title='Upstox Pro', host='127.0.0.1', port=8080, dark=True)
